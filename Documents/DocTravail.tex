\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
%\usepackage[french]{babel}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{verbatim}

\author{Donatien Dallery}
\title{Chaine de traitement MODIS pour automatiser la production et la diffusion de l'evaporative fraction}
\begin{document}
\maketitle

\begin{abstract}
Production d'une chaîne de traitement visant à montrer l'intérêt d'une information spatiale concernant des données à suivre au cours du temps à l'échelle de la Bretagne. Dans un premier temps, la condition hydrique via l'Evaporative Fraction (EF) calculé à partir de données MODIS est mis à contribution.
\end{abstract}

\section{Introduction}

Dans un premier temps, une démonstration de l'apport d'une donnée (EF) continue dans le temps à l'échelle de Bretagne est attendue. Pour cela, entre 4-6 images MODIS continues (à partir de Mai) vont être utilisées pour montrer l'évolution de l'état hydrique. Cette démonstration sera accessible sur un geoserver, faisant que certains outils (graphiques, curseurs, animations) sont également à réaliser. 

\subsection{Plan de travail}

\begin{itemize}
\item Téléchargement et stockage automatique des images MODIS (bandes + TempJour et TempNuit S8)
\item Calcul du NDVI, bord chaud/froid via nuage de points, récupérer 5\% min et max pour calculer EF
\item Remplir une fiche de métadonnées
\item Présenter le résultat
\end{itemize}

\section{Méthodologie}

La méthodologie correspond à une chaîne de traitement développée en Python.

\subsection{Téléchargement des données MODIS}

\begin{itemize}
\item Les données MODIS se situent sur le site \verb!https://lpdaac.usgs.gov/data_access/data_pool.!
\item Pour la Bretagne, il faut télécharger la tuile h17v04. 
\item Le capteur MODIS Terra va être celui qui sera utilisé pour calculer le NDVI (J. Wang et al., 2007) et aussi pour les autres informations.
\item Pour les températures jour/nuit S8 à 1km, le produit est MOD11A2 avec les produits LST day et night (température en Kelvin) avec un scale factor de 0.02.
\item Les bandes Red et Nir MODIS sont disponibles via le produit MOD09Q1 S8 à 250m avec un scale factor de 0.0001.
\end{itemize}  

La nomenclature des noms de fichiers est la suivante :
\begin{itemize}
\item MYD11A2.AYYYYDDD.hHHvVV.CCC.YYYYDDDHHMMSS.hdf
\begin{itemize}
\item YYYYDDD = Year and Day of Year of acquisition
\item hHH = Horizontal tile number (0-35)
\item vVV = Vertical tile number (0-17)
\item CCC = Collection number
\item YYYYDDDHHMMSS = Production Date and Time
\end{itemize}
\end{itemize}

L'évapotranspiration est disponible dans les données MODIS (MOD16A2) calculé selon cette méthode (http://www.ntsg.umt.edu/project/mod16).

\begin{enumerate}
\item Lancement du script (-path pour le répertoire où sauvegarder les données, -date pour indiquer la date à partir de laquelle on souhaite télécharger les images. Si le paramètre n'est pas indiqué, c'est la date du jour qui est utilisé).
\item Liste toutes les dates entre celle indiqué en paramètre et la date du jour.
\item Initialise l'url pour télécharger les données.
\item Se place au niveau de l'url et liste tous les liens à télécharger.
\item Télécharge les images (nécessité de générer un fichier .netrc contenant l'identifiant de connexion. Ce fichier est à placer à l'endroit où le terminal de commande est exécuté).
\end{enumerate}

Concernant une perspective, il serait intéressant de donner des intervalles de temps et non pas une date de départ.

\subsection{Calcul de l'Evaporative Fraction (EF)}

Lors de cette étape, nous disposons des bandes du rouge et du proche infrarouge, mais aussi des températures de jour et de nuit en Kelvin.

\begin{enumerate}
\item Liste tous les fichiers téléchargés.
\item  Pour chaque fichier, converti le type .hdf vers .GeoTiff et rééchantillonne les températures à la résolution spatiale des bandes du rouge et proche infrarouge (1km vers 250m).
\item Utilisation d'un shapefile de la région Bretonne pour découper la tuile MODIS et masquer les valeurs aberrantes de la mer.
\item Calcule le NDVI et supprime les valeurs <0 et >1 (valeurs aberrantes se situant dans la mer et qui ne peuvent être masquée sans rogner sur le territoire).
\item Calcul du FVC via le NDVI.
\item Supprime les pixels sans données (Nan) sur les images (si un pixel est Nan sur une image, supprime le même pixel sur l'autre) et calcule Tj-Tn.
\item Assigne une valeur Nan au FVC aux endroits où il n'y a pas de données sur Tj-Tn.
\item Génère un nuage de points pour employer la méthode de Priestley-Taylor pour déterminer EF par l'utilisation d'une équation de droite selon les bords sec et humide.
\item Génère les droites de régression et détermine l'équation pour calculer EF pour chacun des points.
\item Calcule EF et génère une image selon cette donnée.
\end{enumerate}

\section{Réunion 16/06/2017 (Donatien, Hervé, Fabrice)}
\begin{itemize}
\item Fait : Estimer coût mémoire (stockage) 4mo par date pour résolution 250m et 1mo pour résolution 1km et temps de téléchargement et calcul des données.
\item Fait : Conserver les données brutes et les diffuser également
\item Fait : Compression "deflate" à ajouter
\item Fait : Publier les bandes brutes decoupee/reechant/compress et les produits calculés.
\item Coverage view -> vue sur le geoserver où l'on indique différents rasters (Donnees brutes + EF)
\item Fait : Zone sans données -> on conserve les zones sans données pour le moment (solution avec interpolation pour recréer via la série temporelle ou faire des synthèse de 16j voir plus ?)
\item Entre deux images (dates), quelle est la pertinence d'une valeur identique entre ces deux dates (déduction qu'il ne s'est rien passé ou pas de temps trop faible pour le voir ?)
\item Pour présenter les valeurs EF, faire un découpage par zones pour donner les valeurs, courbes, etc... par zones et non pas à l'échelle du pixel.
\item Organigramme -> traitement en verticale et publication vers la droite.
\item Fait : Publier sur GeoSas des donnees.
\item Creer un GeoRss + mail + tweet + page html avec lien direct pour animation, donnees pour informer sur de la publication de donnees + lien vers mviewer.
\item Geoxxx pour traitement et mise au point (temps telechargement, traitement, demo) et geoserver pour publication (Geowww) via un upload à partir de geoxxx
\item wms time \verb!http://docs.geoserver.org/latest/en/user/services/wms/time.html! pour tester la visualisation + interaction (calendrier, frise chronologique)
\item \verb!http://kartenn.region-bretagne.fr/mviewer/! pour trouver exemple time dans le wms pour generer une couche appelant toutes les dates.
\item coverage view = 1 workspace par date (probablement)
\item Publication des temperatures jour/nuit avec data story (voici les villes, voila 2003 avec l'effet des secheresses, etc...). Pas uniquement présenter les donnees brutes, fournir une analyse.
\item Activer partie temporelle via buildup sur le geoserver (buildup = exemple) avec liste de date, liste et intervalle
\item FAIT : parametre de connexion en indiquant l'url des fichiers login.
\item Est ce que toutes les dates doivent être referencee sur un index spatiale ou temporelle ?
\item Geoserver utilise un shapefile pour lire l'emprise des fichiers tif. Pour l'ajout d'une date, il faut mettre à jour le shapefile cree par le geoserver pour lui indiquer l'emprise du fichier ou bien passer par un reload.
\item Cron tab pour automatiser l'execution des scripts à une frequence de son choix ou jenkins.
\item             lco tile=True (tuilage interne du format
            compress = deflate)
\end{itemize}

\subsection{Publication d'une série temporelle (rasters) sur un GeoServer}

\begin{enumerate}
\item Normaliser le nom des rasters : indice\_date.tif (EF\_20170525.tif).
\item Créer un fichier timeregex.properties pour indiquer le nombre de caractères constituant la date :
\begin{verbatim}
	regex=[0-9]{8}
\end{verbatim}
\item Créer un fichier indexer.properties :
\begin{verbatim}
	TimeAttribute=ingestion
	ElevationAttribute=elevation
Schema=*the_geom:Polygon,location:String,ingestion:java.util.Date,elevation:Integer
PropertyCollectors=TimestampFileNameExtractorSPI[timeregex](ingestion)
\end{verbatim}
\item Importer les rasters et les deux fichiers properties sur le serveur. Dans notre cas, sur Pydio Geoxxx.
\item Sur le GeoServer, créer un workspace (\verb!https://geoxxx.agrocampus-ouest.fr/teledectBZH!).
\item Créer un entrepôt ImageMosaic en indiquant le workspace créé précédemment, un nom d'entrepôt, une description et l'url du dossier où sont stockés les rasters et fichiers properties (\verb!file:///home/data/gi2016/teledectBZH/!). Dans cette configuration, un shapefile est automatiquement créé et a pour rôle d'indexer les différents raster par ordre chronologique et de les spatialiser.
\item Créer un sld correspondant aux valeurs de la série temporelle :
\begin{verbatim}
<?xml version="1.0" ?>
<sld:StyledLayerDescriptor version="1.0.0" xmlns="http://www.opengis.net/sld" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:sld="http://www.opengis.net/sld">
    <sld:UserLayer>
        <sld:LayerFeatureConstraints>
            <sld:FeatureTypeConstraint/>
        </sld:LayerFeatureConstraints>
        <sld:UserStyle>
            <sld:Name>NDVI_05_12_16</sld:Name>
            <sld:Title/>
            <sld:FeatureTypeStyle>
                <sld:Name/>
                <sld:Rule>
                    <sld:RasterSymbolizer>
                        <sld:Geometry>
                            <ogc:PropertyName>grid</ogc:PropertyName>
                        </sld:Geometry>
                        <sld:Opacity>1</sld:Opacity>
                        <sld:ColorMap type="ramp">
                            <sld:ColorMapEntry color="#d7191c" quantity="0" label="0 - 0.1" opacity="1"/>
                            <sld:ColorMapEntry color="#e34a33" quantity="0.1" label="0.1 - 0.2" opacity="1"/>
                            <sld:ColorMapEntry color="#f07c4a" quantity="0.2" label="0.2 - 0.3" opacity="1"/>
                            <sld:ColorMapEntry color="#fdae61" quantity="0.3" label="0.3 - 0.4" opacity="1"/>
                            <sld:ColorMapEntry color="#fdc980" quantity="0.4" label="0.4 - 0.5" opacity="1"/>
                            <sld:ColorMapEntry color="#fee49f" quantity="0.5" label="0.5 - 0.6" opacity="1"/>
                            <sld:ColorMapEntry color="#ffffbf" quantity="0.6" label="0.6 - 0.7" opacity="1"/>
                            <sld:ColorMapEntry color="#e3f2cd" quantity="0.7" label="0.7 - 0.8" opacity="1"/>
                            <sld:ColorMapEntry color="#c7e5db" quantity="0.8" label="0.8 - 0.9" opacity="1"/>
                            <sld:ColorMapEntry color="#abd9e9" quantity="0.9" label="0.9 - 1.0" opacity="1"/>
                            <sld:ColorMapEntry color="#80b9d8" quantity="1" label="1.0 - 1.1" opacity="1"/>
                            <sld:ColorMapEntry color="#569ac7" quantity="1.1" label="1.1 - 1.2" opacity="1"/>
                            <sld:ColorMapEntry color="#2c7bb6" quantity="1.2" label="1.2 - 1.26" opacity="1"/>
                        </sld:ColorMap>
                    </sld:RasterSymbolizer>
                </sld:Rule>
            </sld:FeatureTypeStyle>
        </sld:UserStyle>
    </sld:UserLayer>
</sld:StyledLayerDescriptor>
\end{verbatim}
\item Créer un layer selon le workspace et l'entrepôt (teledectBZH:EF\_teledectBZH). Penser à renseigner les métadonnées, projection (Force declared), indiquer "ingestion D" dans la cellule SORTING, nommer l'attribut du raster (EF) et son échelle de valeurs (0 - 1.26), indiquer le sld dans l'onglet Publishing et dans l'onglet Dimensions activer le Time et choisir l'option "List".
\item Finalement, aller dans Layer Preview, sélectionner le layer et dans l'url, rajouter \&time=date pour choisir la date à afficher (\&time=2017-05-25).
\end{enumerate}

\subsection{Mise à jour d'une série temporelle (rasters) sur un GeoServer}

\begin{enumerate}
\item X : transférer le fichier sur le serveur Pydio uniquement.
\item X : reload Configuration and catalog.
\item X : mettre a jour manuellement le shapefile.
\item V : \verb!curl -v -u gi2016:*gi2016* -XPOST -H "Content-type: text/plain" -d "file:///home/data/gi2016/teledectBZH/EF_20170602.tif" "http://geoxxx.agrocampus-ouest.fr/geoserver/rest/workspaces/teledectBZH/coveragestores/EF_teledectBZH/external.imagemosaic"! \smallbreak
Avec -d qui est le chemin du fichier sur le serveur et l'url consiste à se placer sur le dépôt et exécuter l'extension external.imagemosaic. Cette commande met à jour le shapefile faisant office de datasource.properties.
\end{enumerate}

\subsection{A faire}
\begin{itemize}
\item Tester l'ajout d'une date sur le GeoServer.
\item Lancer la publication d'une serie d'images \verb!http://docs.geoserver.org/latest/en/user/rest/examples/curl.html! uploading image mosaic
\end{itemize}
\section{Bibliographie}

Comparisons of normalized difference vegetation index from MODIS Terra and Aqua data in northwestern China (http://ieeexplore.ieee.org/document/4423572/)
\end{document}